<!DOCTYPE html>

<!--
   Copyright 2012 Shane Bell

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 -->

<html>

<head>

<title>JaSON</title>

<!-- JQuery -->
<script src="js/jquery-1.7.1.min.js" type="text/javascript"></script>

<!-- Twitter Bootstrap -->    
<link href="css/bootstrap.min.css" rel="stylesheet">
<script src="js/bootstrap-transition.js"></script>
<script src="js/bootstrap-modal.js"></script>

<!-- Google Pretty Printer -->
<link href="css/prettify.css" rel="stylesheet">
<script src="js/prettify.js"></script>

<!--  Custom Styles -->
<style type="text/css">
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
</style>

<script type="text/javascript">
$(document).ready(function() {
	
	var version = "v1.0.0";
	
	$(".version").html(version);
	
	// default focus on the URL field
	$("#url").focus();
	
	$("#addHeader").click(addHeaderInput);

	$("#send").click(sendRequest);
	
	$(document).on("click", ".icon-remove", function() {
		$(this).parent().remove();
	});
	
	$("#responseTab, #responseHeadersTab").click(manageTabs);
	
	$("#aboutModal").modal({
		show: false
	});
	
});

/**
 * Reset everything before sending a request.
 */
function reset() {
	
	$("#responseHeadersTab").removeClass("active");
	$("#responseTab").addClass("active");
	
	$("#responseCode").hide();
	$("#responseCode").html("");
	$("#responseCode").removeClass("label-important");
	$("#responseCode").removeClass("label-success");
	
	$("#response").hide();
	$("#response").html("");
	$("#responseHeaders").hide();
	$("#responseHeaders").html("");
	
	$(".help-inline").hide();
	$(".help-inline").html("");
	
	$(".control-group").removeClass("error");
}

/**
 * Validate inputs and show error messages.
 */
function validate() {
	
	var valid = true;
	
	var url = $("#url").val().trim();
	if (url == "") {
		$("#urlGroup").addClass("error");
		$("#urlError").html("URL is required");
		$("#urlError").show();
		$("#url").focus();
		valid = false;
	}
	
	return valid;
}

/**
 * Manage the display of the result tabs.
 */
function manageTabs() {
	
	$("#responseTab, #responseHeadersTab").removeClass("active");
	$(this).addClass("active");
	
	var response = $("#response");
	if (response.html() != "") {
		response.toggle();
	}
	
	var responseHeaders = $("#responseHeaders");
	if (responseHeaders.html() != "") {
		responseHeaders.toggle();
	}
}

/**
 * Construct the request and send it.
 */
function sendRequest() {
	
	reset();
	
	if (!validate()) {
		return false;	
	}
	
	$("#loading").show();

    var ajaxArgs = {
		url: getURL("#url"),
        type: $("#method").val(),
    	contentType: "application/x-www-form-urlencoded",
        processData: true,
		beforeSend: processHeaders,
		dataType: "json",
        data: $("#data").val(),
		success: successResponse,
		error: errorResponse
	};

    // some things change depending on the method
    var method = $("#method").val();
    if (method == "GET") {
        ajaxArgs.data = "";
    } else if (method == "POST") {
		ajaxArgs.processData = false;
        ajaxArgs.contentType = "application/json";
    }

	$.ajax(ajaxArgs);
}

/**
 * Get a URL string from the given selector and clean it up
 * by trimming and prefixing with http if necessary.
 */
function getURL(selector) {
    var url = $(selector).val().trim();
    return url.indexOf("http") != 0 ? "http://" + url : url;
}

/**
 * Add headers to the request. 
 */
function processHeaders(jqXHR) {
    $(".header").each(function() {
		var name = $(".name", this).val().trim();
        var value = $(".value", this).val().trim();
        
	    // TODO show an error message for headers that don't have any content
	    
        if (name == "" || value == "") {
        	$(this).remove();
        } else {
	        jqXHR.setRequestHeader(name, value);
        }
    });
}

/**
 * Called when the AJAX response returns success.
 */
function successResponse(data, textStatus, jqXHR) {
	$("#responseCode").html(jqXHR.status + ": " + jqXHR.statusText);
	$("#responseCode").addClass("label-success");
	$("#response").html(JSON.stringify(data, null, 2));
	$("#responseHeaders").html(jqXHR.getAllResponseHeaders());
	prettyPrint();
	$("#loading").hide();
	$("#responseCode").show();
	$("#response").show();
};

/**
 * Called when the AJAX response returns an error.
 */
function errorResponse(jqXHR, textStatus, errorThrown) {
	$("#responseCode").html(jqXHR.status + ": " + jqXHR.statusText);
	$("#responseCode").addClass("label-important");
	if (jqXHR.getResponseHeader("Content-Type").indexOf("application/json") == 0) {
		try {
	    	$("#response").html(JSON.stringify(JSON.parse(jqXHR.responseText), null, 2));
		} catch (exception) {
	    	$("#response").html(jqXHR.responseText);
		}
	}
	$("#responseHeaders").html(jqXHR.getAllResponseHeaders());
	prettyPrint();
	$("#loading").hide();
	$("#responseCode").show();
	if ($("#response").html() != "") {
		$("#response").show();
	}
}

/**
 * Add a request header input field (name and value) to the page
 */
function addHeaderInput() {
	var header = $("<li class='header'><input type='text' class='name' placeHolder='name'/>&nbsp;<input type='text' class='value' placeHolder='value'/>&nbsp;<i class='icon-remove'></i></li>");
	$("#requestHeaders").append(header);
}

/**
 * Google analytics
 */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-30163240-1']);
_gaq.push(['_trackPageview']);

(function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = 'https://ssl.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</head>
    
<body>

	<!-- Navbar -->    
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a href="#" class="brand">JaSON</a>
				<img src="img/icon_32.png" style="padding-top: 4px"></img>
                <ul class="nav pull-right">
					<li>
						<a id="about" data-toggle="modal" href="#aboutModal">About</a>
					</li>
                </ul>
			</div>
		</div>
	</div>
	
	<!-- Container -->
	<div class="container">
	
		<!-- URL and method -->
		<div class="row">
			<div id="urlGroup" class="control-group">
	            <div class="controls">
					<input type="text" id="url" class="span6" placeHolder="http://www.example.com/service.json"/>
					<span id="urlError" class="help-inline" style="display:none"></span>
	            </div>
	        </div>
			<div class="control-group">
	            <div class="controls">
					<select id="method" class="span2">
						<option>GET</option>
						<option>POST</option>
						<option>PUT</option>
						<option>DELETE</option>
						<option>HEAD</option>
					</select>
	            </div>
	        </div>
	    </div>

		<!-- Request headers -->
		<div class="row">
			<div class="control-group">
			    <h3>HTTP headers</h3>
			    <div class="controls">
				    <ul id="requestHeaders" class="unstyled">
				    </ul>
				    <button class="btn" id="addHeader">Add HTTP header</button>
			    </div>
		    </div>
		</div>
		
		<!-- Request body -->
		<div class="row">
	    	<h3>Request Body</h3>
	    	<div class="control-group">
	    		<div class="controls">
			    	<textarea id="data" class="span6" rows="5"></textarea>
	    		</div>
	    	</div>
		</div>
		
		<!-- Submit and results -->
		<div class="row">
			<div class="form-actions">
				<input type="button" class="btn btn-primary" id="send" value="Send Request" />
			</div>
			
			<!-- Response tabs -->
			<ul class="nav nav-tabs">
				<li id="responseTab" class="active">
					<a href="javascript:void(0)">Response</a>
				</li>
				<li id="responseHeadersTab">
					<a href="javascript:void(0)">Response Headers</a>
				</li>
			</ul>
			
			<img id="loading" src="img/loading.gif" style="display:none" />
			
			<p>
				<span id="responseCode" class="label" style="display:none"></span>
			</p>
			<pre id="response" class="prettyprint" style="display:none"></pre>
			<pre id="responseHeaders" class="prettyprint" style="display:none"></pre>
		</div>
		
		<!-- Footer -->
      <footer class="footer">
        <p class="help-block pull-right version"></p>
      </footer>
		
	</div>

	<div id="aboutModal" class="modal fade" style="display:none">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">x</a>
			<h3>JaSON</h3>
			<p class="version"></p>
		</div>
		<div class="modal-body">
			<p>
				<img src="img/icon_128.png"></img>
			</p>
			<p>
				Developed and maintaned by Shane Bell
				<br/>
				<a href="mailto:shane.bell@gmail.com" target="new">shane.bell@gmail.com</a>
			</p>
			<p>
				JaSON is distributed under the terms of the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>
			</p>
			<p>
				Source code available on GitHub
				<br/>
				<a href="https://github.com/shanebell/JaSON">https://github.com/shanebell/JaSON</a>
			</p>
			<p>
				Friday the 13th icon designed by Tony Gil
				<br/>
				<a href="http://tonygil.com/">http://tonygil.com/</a>
			</p>
		</div>
		<div class="modal-footer">
			<a href="#" class="btn btn-primary" data-dismiss="modal">Close</a>
		</div>
	</div>

</body>

</html>
