<!DOCTYPE html>

<!--
   Copyright 2012 Shane Bell

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 -->

<html>

<head>

<title>JaSON</title>

<!-- JQuery -->
<script src="js/jquery-1.7.1.min.js" type="text/javascript"></script>

<!-- Twitter Bootstrap -->    
<link href="css/bootstrap.min.css" rel="stylesheet">
<script src="js/bootstrap-transition.js"></script>
<script src="js/bootstrap-modal.js"></script>

<!-- Google Pretty Printer -->
<link href="css/prettify.css" rel="stylesheet">
<script src="js/prettify.js"></script>

<!--  Custom Styles -->
<style type="text/css">
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
</style>

<script type="text/javascript">
$(document).ready(function() {
	
	var version = "v1.0";
	
	$(".version").html(version);
	
	// default focus on the URL field
	$("#url").focus();
	
	$("#addHeader").click(addHeaderInput);

	$("#send").click(sendRequest);
	
	$(document).on("click", ".deleteHeader", function() {
		$(this).parents(".header").remove();
	});
	
	$("#responseTab, #responseHeadersTab").click(manageTabs);
	
	$("#aboutModal").modal({
		show: false
	});
	
});

/**
 * Reset field visibility, css classes etc back to the default state.
 */
function reset() {
	
	$("#responseHeadersTab").removeClass("active");
	$("#responseTab").addClass("active");
	
	$("#responseCode").hide();
	$("#responseCode").html("");
	$("#responseCode").removeClass("label-important");
	$("#responseCode").removeClass("label-success");
	
	$("#response").hide();
	$("#response").html("");
	$("#responseHeaders").hide();
	$("#responseHeaders").html("");
	
	$(".help-inline").hide();
	$(".help-inline").html("");
	
	$(".control-group").removeClass("error");
}

/**
 * Validate inputs and show error messages.
 */
function validate() {
	
	var valid = true;
	
	// validate URL
	var url = $("#url").val().trim();
	if (url == "") {
		valid = false;
		$("#urlError").html("URL is required");
		$("#urlGroup").addClass("error");
		$("#urlError").show();
		$("#url").focus();
	}
	
	// validate request headers
	var headers = [];
	$(".header").each(function() {
		var name = $(".name", this).val().trim().toLowerCase();
        var value = $(".value", this).val().trim();
        
        if (name == "" || value == "") {
        	valid = false;
        	$(".help-inline", this).html("Header name and value are required");
        	$(".control-group", this).addClass("error");
        	$(".help-inline", this).show();
        } else if (headers.indexOf(name) >= 0) {
        	valid = false;
        	$(".help-inline", this).html("A header with this name already exists");
        	$(".control-group", this).addClass("error");
        	$(".help-inline", this).show();
        } else {
			headers.push(name);
        }
    });
	
	// validate request body
	var requestBody = $("#requestBody").val().trim();
	if (requestBody != "") {
		try {
			JSON.parse(requestBody);
		} catch (exception) {
			valid = false;
			$("#requestBodyError").html("Invalid JSON: " + exception.message);
			$("#requestBodyGroup").addClass("error");
			$("#requestBodyError").show();
		}		
	}
	
	return valid;
}

/**
 * Manage the display of the result tabs.
 */
function manageTabs() {
	
	$("#responseTab, #responseHeadersTab").removeClass("active");
	$(this).addClass("active");
	
	var response = $("#response");
	if (response.html() != "") {
		response.toggle();
	}
	
	var responseHeaders = $("#responseHeaders");
	if (responseHeaders.html() != "") {
		responseHeaders.toggle();
	}
}

/**
 * Construct a request and send it.
 */
function sendRequest() {
	
	reset();
	
	if (!validate()) {
		return false;	
	}
	
	$("#loading").show();

    var ajaxArgs = {
		url: getURL("#url"),
        type: $("#method").val(),
    	contentType: "application/x-www-form-urlencoded",
        processData: true,
		beforeSend: processHeaders,
		dataType: "json",
        data: $("#requestBody").val(),
		success: successResponse,
		error: errorResponse
	};

    // some things change depending on the method
    var method = $("#method").val();
    if (method == "GET") {
        ajaxArgs.data = "";
    } else if (method == "POST") {
		ajaxArgs.processData = false;
        ajaxArgs.contentType = "application/json";
    }

    trackRequest(ajaxArgs.url);
    
	$.ajax(ajaxArgs);
}

/**
 * Get a URL string from the given selector and clean it up
 * by trimming and prefixing with http if necessary.
 */
function getURL(selector) {
    var url = $(selector).val().trim();
    return url.indexOf("http") != 0 ? "http://" + url : url;
}

/**
 * Add headers to the request. 
 */
function processHeaders(jqXHR) {
    $(".header").each(function() {
		var name = $(".name", this).val().trim();
        var value = $(".value", this).val().trim();
        
        if (name == "" || value == "") {
        	$(this).remove();
        } else {
	        jqXHR.setRequestHeader(name, value);
        }
    });
}

/**
 * Called when the AJAX response returns success.
 */
function successResponse(data, textStatus, jqXHR) {
	processResponse(jqXHR, true);
};

/**
 * Called when the AJAX response returns an error.
 */
function errorResponse(jqXHR, textStatus, errorThrown) {
	processResponse(jqXHR, false);
}

/**
 * Process a response. A successful (ie: non error) response is indicated by setting 'success' to true.
 */
function processResponse(jqXHR, success) {
	
	// response code and headers
	$("#responseCode").addClass(success ? "label-success" : "label-important");
	$("#responseCode").html(jqXHR.status + ": " + jqXHR.statusText);
	$("#responseHeaders").html(jqXHR.getAllResponseHeaders());

	// parse the response body if there is one
	var data = jqXHR.responseText;
	var contentType = jqXHR.getResponseHeader("Content-Type");
	if (contentType != null && contentType.indexOf("application/json") == 0 && data != null) {
		try {
	    	$("#response").html(JSON.stringify(JSON.parse(data), null, 2));
		} catch (exception) {
			
			// JSON must be invalid, just show it unparsed
	    	$("#response").html(data);
		}
	}
	
	// pretty print the response and response headers
	prettyPrint();
	
	// show the response
	$("#loading").hide();
	$("#responseCode").show();
	if ($("#response").html() != "") {
		$("#response").show();
	}
}

/**
 * Add a request header input field (name and value) to the page
 */
function addHeaderInput() {
	var header = $(".headerPrototype").clone();
	header.removeClass("headerPrototype");
	header.addClass("header");
	$("#requestHeaders").append(header);
	header.show();
}

/**
 * Google analytics
 */
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-30163240-1']);
_gaq.push(['_trackPageview']);

(function() {
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = 'https://ssl.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

function trackRequest(url) {
	_gaq.push(['_trackEvent', 'Request made to ' + url]);	
}
</script>
</head>
    
<body>

	<!-- Navbar -->    
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a href="#" class="brand">JaSON</a>
				<img src="img/icon_32.png" style="padding-top: 4px"></img>
                <ul class="nav pull-right">
					<li>
						<a id="about" data-toggle="modal" href="#aboutModal">About</a>
					</li>
                </ul>
			</div>
		</div>
	</div>
	
	<!-- Container -->
	<div class="container">
	
		<!-- URL and method -->
		<div class="row">
			<div id="urlGroup" class="control-group">
	            <div class="controls">
					<input type="text" id="url" class="span6" placeHolder="http://www.example.com/service.json"/>
					<span id="urlError" class="help-inline" style="display:none"></span>
	            </div>
	        </div>
			<div class="control-group">
	            <div class="controls">
					<select id="method" class="span2">
						<option>GET</option>
						<option>POST</option>
						<option>PUT</option>
						<option>DELETE</option>
						<option>HEAD</option>
					</select>
	            </div>
	        </div>
	    </div>

		<!-- Request headers -->
		<div class="row">
			<div class="control-group">
			    <h3>HTTP headers</h3>
			    <div class="controls">
				    <ul id="requestHeaders" class="unstyled">
				    	
				    	<!-- Prototype header row to be cloned and added to the list -->
				    	<li class="headerPrototype" style="display:none">
				    		<div class="control-group">
				    			<div class="controls">
				    				<input type="text" class="name" placeHolder="name"/>&nbsp;
				    				<input type="text" class="value" placeHolder="value"/>&nbsp;
				    				<a href="javascript:void(0)"<i class="icon-remove deleteHeader"></i></a>
				    				<span class="help-inline" style="display:none"></span>
				    			</div>
				    		</div>
				    	</li>
				    </ul>
				    <button class="btn" id="addHeader">Add HTTP header</button>
			    </div>
		    </div>
		</div>
		
		<!-- Request body -->
		<div class="row">
	    	<h3>Request Body</h3>
	    	<div id="requestBodyGroup" class="control-group">
	    		<div class="controls">
			    	<textarea id="requestBody" class="span6" rows="5"></textarea>
					<span id="requestBodyError" class="help-inline" style="display:none"></span>
	    		</div>
	    	</div>
		</div>
		
		<!-- Submit and results -->
		<div class="row">
			<div class="form-actions">
				<input type="button" class="btn btn-primary" id="send" value="Send Request" />
			</div>
			
			<!-- Response tabs -->
			<ul class="nav nav-tabs">
				<li id="responseTab" class="active">
					<a href="javascript:void(0)">Response</a>
				</li>
				<li id="responseHeadersTab">
					<a href="javascript:void(0)">Response Headers</a>
				</li>
			</ul>
			
			<img id="loading" src="img/loading.gif" style="display:none" />
			
			<p>
				<span id="responseCode" class="label" style="display:none"></span>
			</p>
			<pre id="response" class="prettyprint" style="display:none"></pre>
			<pre id="responseHeaders" class="prettyprint" style="display:none"></pre>
		</div>
		
		<!-- Footer -->
      <footer class="footer">
        <p class="help-block pull-right version"></p>
      </footer>
		
	</div>

	<div id="aboutModal" class="modal fade" style="display:none">
		<div class="modal-header">
			<i class="icon-remove close" data-dismiss="modal"></i>
			<h3>JaSON</h3>
			<p class="version"></p>
		</div>
		<div class="modal-body">
			<p>
				<img src="img/icon_128.png"></img>
			</p>
			<p>
				Developed and maintaned by Shane Bell
				<br/>
				<a href="mailto:shane.bell@gmail.com" target="new">shane.bell@gmail.com</a>
			</p>
			<p>
				JaSON is open source and distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>
			</p>
			<p>
				Source code available on GitHub
				<br/>
				<a href="https://github.com/shanebell/JaSON">https://github.com/shanebell/JaSON</a>
			</p>
			<p>
				Friday the 13th icon designed by Tony Gil
				<br/>
				<a href="http://tonygil.com/">http://tonygil.com/</a>
			</p>
		</div>
		<div class="modal-footer">
			<a href="#" class="btn btn-primary" data-dismiss="modal">Close</a>
		</div>
	</div>

</body>

</html>
